---
title: 同步和异步
categories:
    - JavaScript
    - 杂七杂八
abbrlink: 73ea086f
date: 2019-06-22 15:53:34
---

# 基本概念

由于JavaScript是单线程的，不能同时运行多段代码，所以就有了**同步**和**异步**的概念。同步就是要立即执行的代码，而异步代码则是要在将来的某一个时刻执行。

因为异步代码是在将来的某一时刻才执行，所以需要有一个任务队列，负责保存这些异步任务。

根据异步任务的不同，保存异步任务的队列，也是分为两种的：**微任务队列**和**宏任务队列**。而**事件循环**就是一种调度机制，它管理着这两个任务队列。

{% note info %}
1. **微任务（优先级递减）**：
    1. `process.nextTick`
    2. `Promise.then`、`Promise.catch`、`Promise.finally`
    3. `Object.observe`
    4. `MutationObserver`
2. **宏任务（优先级递减）**：
    1. `setTimeout`
    2. `setInterval`
    3. `setImmediate`
    4. `I/O`
    5. `UI rendering`

---
- 执行优先级：同步 > 微任务 > 宏任务。
- 同样是微任务，或者同样是宏任务，它们之间也是有优先级的。
- 事件循环机制每次只会从宏任务队列中取出一个任务执行，但是会将微任务队列中的所有任务都执行。
- 当前微任务队列中还有任务没执行完成之前，事件循环不会去执行下一个宏任务。
{% endnote %}

{% note warning %}
**传递给`Promise.then()`这样的参数需要是一个函数，如果直接传递一行代码，它也能工作，但是那是不对的！！！而且这样的话，好像就把这个代码也当作同步代码的，而不是加入到微任务队列中。**
{% endnote %}

```js
let queue = []

setImmediate(() => {
    queue.push(1)
},0)

setTimeout(() => {
    queue.push(2)
},0)

new Promise((resolve, reject) => {
    queue.push(3)
    resolve()
    queue.push(4)
}).then(() => {
    queue.push(5)
})

queue.push(6)

process.nextTick(() => {
    queue.push(7)
})

queue.push(8)

setTimeout(() => {
    console.log(queue)
}, 2000)
// [ 3, 4, 6, 8, 7, 5, 2, 1 ]
```

# 加入async函数

[**首先请理解 async 函数**](https://aadonkeyz.com/posts/ca9ee217/)

{% note warning %}
**在`async`函数中，每个`await`或者`return`返回的都是一个 Promise 实例，而在`await`后面的代码，都相当于是该`await`返回的 Promise 实例对象上`.then()`中的内容。**
{% endnote %}

```js
async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}
async function async2() {
    console.log('async2');
}
console.log('script start');
setTimeout(function() {
    console.log('setTimeout');
}, 0)
async1();
new Promise(function(resolve) {
    console.log('promise1');
    resolve();
}).then(function() {
    console.log('promise2');
});
console.log('script end');
// script start
// async1 start
// async2
// promise1
// script end
// promise2
// async1 end
// setTimeout



async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}
function async2() {
    console.log('async2');
}
console.log('script start');
setTimeout(function() {
    console.log('setTimeout');
}, 0)
async1();
new Promise(function(resolve) {
    console.log('promise1');
    resolve();
}).then(function() {
    console.log('promise2');
});
console.log('script end');
// script start
// async1 start
// async2
// promise1
// script end
// async1 end
// promise2
// setTimeout
```
