---
title: 同步和异步
categories:
    - JavaScript
    - 个人总结
abbrlink: 73ea086f
date: 2019-06-22 15:53:34
---


由于JavaScript是单线程的，不能同时运行多段代码，所以就有了**同步**和**异步**的概念。同步就是要立即执行的代码，而异步代码则是要在将来的某一个时刻执行。

因为异步代码是在将来的某一时刻才执行，所以需要有一个任务队列，负责保存这些异步任务。

根据异步任务的不同，保存异步任务的队列，也是分为两种的：**微任务队列**和**宏任务队列**。而**事件循环**就是一种调度机制，它管理着这两个任务队列。

{% note info %}
1. **微任务**：
    - `Promise`
    - `MutationObserver`
2. **宏任务**：
    - `setTimeout`
    - `setInterval`
    - `setImmediate`
    - IO事件
    - DOM事件

---
- 执行优先级：同步 > 微任务 > 宏任务
- 事件循环机制每次只会从宏任务队列中取出第一个宏任务进行执行，但是会将微任务队列中的所有任务按照顺序取出并执行
- 当前微任务队列中还有任务没执行完成之前，事件循环不会去执行下一个宏任务
{% endnote %}

```js
setTimeout(() => {
    alert(3)
    new Promise((resolve, reject) => {
        alert(4)
        resolve()
    }).then(alert(5))
}, 10)

setTimeout(() => {
    alert(6)
}, 20)

new Promise((resolve, reject) => {
    alert(1)
    resolve()
}).then(alert(2))
```

{% note info %}
1. 执行第一个`setTimeout`，告诉浏览器在当前同步代码执行完成后，等待10毫秒将它所包含的代码加入宏任务。
2. 执行第二个`setTimeout`，告诉浏览器在当前同步代码执行完成后，等待20毫秒将它所包含的代码加入宏任务。
3. 执行`new Promise`，他所包含的内容都是同步的，所以`alert(1)`和`resolve()`立即被执行。然后`.then()`所包含的代码被添加到微任务队列。
4. 当前所有同步代码执行完毕，等待10毫秒后将步骤1中的代码加入宏任务队列。再等待10毫秒，将步骤2的代码加入宏任务队列。
5. 目前微任务队列中有一个任务，宏任务队列中有两个任务。事件循环机制开始工作，取出微任务中的任务开始执行，即`alert(2)`被执行。
6. 微任务队列已清空，事件循环机制从宏任务队列中取出第一个宏任务开始执行，即`alert(3)`被执行。
    1. `alert(3)`立即被执行。
    2. 执行`new Promise`中的`alert(4)`，然后将`.then()`所包含的代码添加到微任务队列。
    3. 同步代码执行完毕，检查微任务队列，发现有一个微任务待处理，取出来执行，所以`alert(5)`被执行。
7. 再次从宏任务队列中取出最后一个宏任务开始执行，即`alert(6)`被执行。
8. 两个任务队列都已清空，执行结束。
{% endnote %}
