---
title: 《图解HTTP》
categories:
  - 计算机网络
abbrlink: 62d10724
date: 2019-06-09 12:21:05
---


# 网络基础

## TCP/IP协议族

计算机与网络设备要相互通信，双方就必须基于相同的方法。比如，如何探测到通信目标、由哪一边先发起通信、使用哪种语言进行通信、怎样结束通信等规则都需要事先确定。不同的硬件、 操作系统之间的通信，所有的这一切都需要一种规则。而我们就把这种规则称为协议，把与互联网相关联的协议集合起来总称为TCP/IP。

{% note info %}
TCP/IP协议族里最重要的一点就是分层，其按层次分为四层：
- **应用层**：决定向用户提供应用服务时通信的活动，FTP、DNS和HTTP均处于该层
- **传输层**：传输层为应用层提供处于网络连接中的两台计算机之间的数据传输，在传输层有两个性质不同的协议：TCP和UDP
- **网络层**：该层规定了通过怎样的路径到达对方计算机，并把数据包（网络传输的最小数据单位）传送给对方
- **链路层**：用来处理连接网络的硬件部分。包括控制操作系统、硬件的设备驱动、NIC，及光纤等物理可见部分
{% endnote %}

![TCP/IP通信传输流](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/TCP%3AIP%E9%80%9A%E4%BF%A1%E4%BC%A0%E8%BE%93%E6%B5%81.png)

利用TCP/IP协议族进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，接收端则从链路层往上走。

发送端在层与层之间传输数据时，每经过一层时必定会被搭上一个该层所属的首部信息。反之，接收端在层与层传输数据时，每经过一层时会把对应的首部消去

## 负责传输的IP协议

{% note warning %}
**IP（协议）**和**IP地址**是两个不同的概念
{% endnote %}

按层次分，IP协议位于网络层，它的作用是把各种数据包传送给对方。而要保证确实传送到对方那里，则需要满足各类条件。其中最重要的条件是**IP地址**和**MAC地址**

{% note info %}
- **IP地址**：指明了节点被分配到的地址
- **MAC地址**：网卡所属的固定地址

IP地址可以和MAC地址进行配对。IP地址可变换，但MAC地址基本上不会更改
{% endnote %}

IP间的通信依赖于MAC地址。在网络上，通信的双方在统一局域网（LAN）内的情况是很少的，通常是经过多台计算机和网络设备中专才能连接到对方。而在进行中转时，会利用下一站中转设备的MAC地址来所搜下一个中转目标。这时，会采用ARP协议。ARP是一种用以解析地址的协议，根据通信方的IP地址就可以反查出对应的MAC地址

![IP间通信](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/IP%E9%97%B4%E9%80%9A%E4%BF%A1.png)

## 确保可靠性的TCP协议

按层次分，TCP位于传输层，提供可靠的字节流服务

所谓的字节流服务是指，为了方便传输，将大块数据分割成以报文段为段位的数据包进行管理。而可靠的传输服务是指，能够把数据准确可靠地传给对方。一言蔽之，TCP协议为了更容易传送大数据才把数据分割，而且TCP协议能够确认数据最终是否送达到对方

为了准确无误地将数据送达目标，TCP协议采用了三次握手策略。

发送端首先先发送一个带SYN标志的数据包给对方。接收端收到后，回传一个带有SYN/ACK标志的数据包以示传达确认信息。最后，发送端再回传一个带ACK标志的数据包，代表“握手”结束。

若在握手过程中某个阶段莫名中断，TCP协议会再次以相同的顺序发送相同的数据包

![TCP三次握手](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png)

## HTTP持久连接

HTTP协议的初始版本中，每进行一次HTTP通信就要断开一次TCP连接。以当年的通信情况来说，因为都是些容量很小的文本传输，所及即使这样也没有多大问题。可随着HTTP的普及，文档中包含大量图片的情况多了起来。因此，每次的请求都会造成无谓的TCP连接建立和断开，增加通信量的开销。

为了解决上述TCP连接的问题，HTTP/1.1和一部分的HTTP/1.0想出了持久连接的方法。持久连接的特点是，只要任意一端没有明确提出断开连接，则保持TCP连接状态。在HTTP/1.1中，所有的连接默认都是持久连接，但在HTTP/1.0内并未标准化。

持久连接使得多数请求以管线化方式发送成为可能。从前发送请求后需等待并收到响应，才能发送下一个请求。管线化技术出现后，不用等待响应亦可直接发送下一个请求。这样就能够做到同时并行发送多个请求，而不需要一个接一个地等待响应了。

## 负责域名解析的DNS服务

DNS服务是和HTTP协议一样位于应用层的协议，它提供域名到IP地址之间的解析服务。

![DNS服务](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/DNS%E6%9C%8D%E5%8A%A1.png)

## 各种协议与HTTP协议的关系

![各种协议与HTTP协议的关系](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E5%90%84%E7%A7%8D%E5%8D%8F%E8%AE%AE%E4%B8%8EHTTP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%85%B3%E7%B3%BB.png)

## URI和URL

URI用字符串标识某一互联网资源，而URL表示资源的地点（互联网上所处的位置）。可见URL是URI的子集

下面列举几种URI例子

```txt
ftp://ftp.is.co.za/rfc/rfc1808.txt
http://user:pass@www.example.jp:80/dir/index.html?uid=1#ch1
ldap://[2001:db8::7]/c=GB?objectClass?one
mailto:John.Doe@example.com
news:comp.infosystems.www.servers.unix
tel:+1-816-555-1212
telnet://192.0.2.16:80/
urn:oasis:names:specification:docbook:dtd:xml:4.1.2
```

# HTTP报文

用于HTTP协议交互的信息被称为HTTP报文。请求端（客户端）的HTTP报文叫做请求报文，响应端（服务器端）的叫做相应报文。

HTTP报文大致可分为报文首部和报文主体两块。两者由最初出现的空行（`CR+LF`）来划分。通常，并不一定要有报文主体。

我们来看一下请求报文和响应报文的结构和实例

![请求报文和响应报文的结构](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%E5%92%8C%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E7%9A%84%E7%BB%93%E6%9E%84.png)
![请求报文实例](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%E5%AE%9E%E4%BE%8B.png)
![响应报文实例](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E5%AE%9E%E4%BE%8B.png)

HTTP在传输数据时可以按照数据原貌直接传输，但也可以在传输过程中通过编码提升传输速率。通过在传输时编码，能有效地处理大量的访问请求。但是编码的操作需要计算机来完成，因此会消耗更多的CPU资源。

{% note info %}
首先要明确实体主体和实体首部的概念，**实体主体是我们想要传输的实际信息，实体首部是对该信息的描述。实体的首部字段被包含在报文首部内，而实体的主体被包含在报文主体中**

---
内容编码指明应用在实体主体上的编码格式，并保持实体信息原样压缩。内容编码后的实体由客户端接收并负责解码。常用的内容编码有以下几种：
- **gzip（GUN zip）**
- **compress（UNIX系统的标准压缩）**
- **deflate（zlib）**
- **identity（不进行编码）**
{% endnote %}

![内容压缩](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E5%86%85%E5%AE%B9%E5%8E%8B%E7%BC%A9.png)

在HTTP通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面。在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面。这种把实体主体分块的功能称为**分块传输编码**

![分块传输编码](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81.png)

分块传输编码会将实体主体分成多个块，每一块都会用十六进制来标记块的大小，而实体主体的最后一块会使用`0(CR+LF)`来标记。

HTTP/1.1中存在一种称为传输编码（Transfer Coding）的机制，它可以在通信时按某种编码方式传输，但只定义作用与分块传输编码中。

下面的例子中，`25`、`1C`、`3`和`8`代表每一个块的大小，而`This is the data in the first chunk`、`and this is the second one`、`con`和`sequence`为实体主体的内容

```txt
HTTP/1.1 200 OK
Content-Type: text/plain
Transfer-Encoding: chunked

25
This is the data in the first chunk

1C
and this is the second one

3
con

8
sequence

0


```

# HTTP方法

![HTTP方法](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/HTTP%E6%96%B9%E6%B3%95.png)

# HTTP状态码

![状态码类别](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E7%8A%B6%E6%80%81%E7%A0%81%E7%B1%BB%E5%88%AB.png)

{% note info %}
- **200 OK**：从客户端发来的请求在服务器端被正常处理了
- **204 No Content**：服务器接收的请求已成功处理，但在返回的响应报文中不含实体的主体部分。另外，也不允许返回任何实体的主体
- **206 Partial Content**：客户端进行了范围请求，而服务器成功执行了这部分的GET请求。响应报文中包含由`Content-Range`指定范围的实体内容

--- 
- **301 Moved Permanently**：请求的资源已被分配了新的URI，以后应使用资源现在所指的URI。也就是说，如果已经把资源对应的URI保存为书签了，这时应该按`Location`首部字段提示的URI重新保存
- **302 Found**：请求的资源已被分配了新的URI，希望用户（本次）能使用新的URI访问。与`301`类似，但是`302`代表的资源不是被永久移动，只是临时性质的
- **303 See Other**：由于请求对应的资源存在着另一个URI，应使用GET方法定向获取请求的资源。与`302`类似，但是`303`明确表示客户端应当采用GET方法获取资源，这点与`302`有区别
- **304 Not Modified**：客户端发送附带条件的请求时，服务器允许请求访问资源，但是未找到满足条件的资源。`304`返回时，不包含任何响应的主体部分，它虽然被划分在`3XX`类别中，但是和重定向没有关系
- **307 Temporary Redirect**：与`302`有着相同的含义。尽管`302`禁止POST变换为GET，但实际使用时大家并不遵守。`307`会遵照浏览器标准，不会从POST变换为GET

---
- **400 Bad Request**：请求报文中存在语法错误，当错误发生时，需修改请求的内容后再次发送请求
- **401 Unauthorized**：发送的请求需要有通过HTTP认证的认证信息，若之前已进行过一次请求，则表示用户认证失败
- **403 Forbidden**：对请求资源的访问被服务器拒绝了。服务器端没有必要给出拒绝的详细理由，但如果想作说明的话，可以在实体的主体部分对原因进行描述，这样就能让用户看到了
- **404 Not Found**：服务器上无法找到请求的资源。除此之外，也可以在服务器端拒绝请求且不想说明理由时使用

---
- **500 Internal Server Error**：服务器端在执行请求时发生了错误。也有可能时Web应用存在的bug或某些临时故障
- **503 Service Unavailable**：服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。如果事先得知解除以上状况需要的时间，最好写入`RetryAfter`首部字段再返回给客户端
{% endnote %}

# 与HTTP协作的Web服务器

## 用单台虚拟主机实现多个域名

HTTP/1.1规范允许一台HTTP服务器搭建多个Web站点，即使物理层面只有一台服务器，但只要使用虚拟主机功能，则可以假想已有多台服务器。

在相同IP地址下，由于虚拟主机可以寄存多个不同主机名和域名的Web网站，因此在发送HTTP请求时，必须在`Host`首部内完整指定主机名或域名的URI

## 通信数据转发程序

{% note info %}
- **代理**：代理是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端
- **网关**：网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉自己的通信目标是一个网关
- **隧道**：隧道是在客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序
{% endnote %}

### 代理

代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求URI，会直接发送给前方持有资源的目标服务。持有资源实体的服务器被称为源服务器，从源服务器返回的响应经过代理服务器后再传给客户端。

每次通过代理服务器转发请求或响应时，会追加写入`Via`首部信息

![代理](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E4%BB%A3%E7%90%86.png)

{% note info %}
使用代理服务器的理由有：
- 利用缓存技术减少网络带宽的流量
- 组织内部针对特定网站的访问控制
- 获取访问日志

---
代理有多种使用方法，按两种基准分类。一种是是否使用缓存，另一种是是否会修改报文
- **缓存代理**：代理转发响应时，缓存代理会预先将资源的副本保存在代理服务器上。当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回
- **透明代理**：转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理。反之，对报文内容进行加工的代理被称为非透明代理
{% endnote %}

### 网关

网关的工作机制和代理十分相似，而网关能使通信线路上的服务器提供非HTTP协议服务

![网关](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E7%BD%91%E5%85%B3.png)

利用网关能提高通信的安全性，因为可以在客户端与网关之间的通信线路上加密以确保连接的安全。比如，网关可以连接数据库，使用SQL语句查询数据。另外，在 Web 购物网站上进行信用卡结算时，网关可以和信用卡结算系统联动

### 隧道

隧道可按要求建立起一条与其他服务器的通信线路，届时使用SSL等加密手段进行通信。隧道的目的是确保客户端能与服务器进行安全的通信。

隧道本身不会去解析HTTP请求，也就是说，请求保持原样中转给之后的服务器。隧道会在通信双方断开连接时结束。

![隧道](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%9B%BE%E8%A7%A3HTTP/%E9%9A%A7%E9%81%93.png)
