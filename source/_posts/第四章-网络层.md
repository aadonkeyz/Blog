---
title: 第四章 网络层
categories:
    - 计算机网络
    - 《计算机网络-自顶向下方法》
abbrlink: 1a710b62
mathjax: true
date: 2019-07-10 12:54:48
---


# 基础概念

{% note info %}
1. **分组交换机**：根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。
2. **链路层交换机**：基于链路层字段中的值做转发决定的分组交换机。
3. **路由器**：基于网络层字段中的值做转发决定的分组交换机。
4. **转发**：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路。**转发是路由器本地的动作，注意区分它与路由选择是不同的。**
5. **路由选择**：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为**路由选择算法**。
6. **转发表**：路由器通过检查到达分组首部字段中的值，然后使用该值在该路由器的转发表中索引查询，最终决定转发到哪条输出链路。
7. **网络服务模型**：定义了分组在发送与接收端系统之间的端到端运输特性。在发送主机中，当运输层向网络层传递一个分组时，能由网络层提供的特定服务包括（**能提供，但是不一定提供。比如因特网只提供了单一的尽力而为服务**。）：
    - **确保交付**
    - **具有时延上街的确保交付**
    - **有序分组交付**
    - **确保最小带宽**
    - **确保最大时延抖动**
    - **安全性服务**
    - **等等**
{% endnote %}

# 虚电路和数据报网络

在介绍运输层的时候，我们提到运输层能够为应用层提供无连接或面向连接服务。例如，因特网的运输层为每个应用程序在两种服务间提供了选择：UDP或TCP。以类似的方式，网络层也能够在两台主机之间提供无连接服务或连接服务。网络层的连接和无连接服务在许多方面与运输层的面向连接和无连接服务类似。例如，网络层连接服务以源和目的主机间的握手开始；网络层无连接服务则没有任何握手预备步骤。

尽管网络层连接和无连接服务与运输层面向连接和无连接服务有类似之处，但也存在重大差异：

{% note info %}
- 在网络层中，这些服务是由网络层向运输层提供的主机到主机间的服务。在运输层中，这些服务则是运输层向应用层提供的进程到进程的服务。
- 在至今为止的所有主要的计算机网络体系结构中（因特网、ATM、帧中继等），网络层或者提供了主机到主机的无连接服务，或者提供了主机到主机的连接服务，而不同时提供这两种服务。仅在网络层提供连接服务的计算机网络称为**虚电路（Virtual-Circuit, VC）网络**；仅在网络层提供无连接服务的计算机网络称为**数据报网络（datagram network）**。
- 在运输层实现面向连接的服务与在网络层实现连接服务是根本不同的。运输层面向连接服务是在位于网络边缘的端系统中实现的；网络层连接服务除了在端系统中，也在位于网络核心的路由器中实现。
{% endnote %}

## 虚电路网络

略

## 数据报网络

在数据报网络中，每当一个端系统要发送分组，它的网络层就为该分组加上目的端系统的地址，然后将分组推进网络中。当分组从源到目的地传输，它通过一系列路由器传递。这些路由器中的每台都使用分组的目的地址来转发该分组。特别是，每台路由器有一个将目的地址映射到链路接口的转发表；当分组到达路由器时，路由器使用该分组的目的地址在转发表中查找适当的输出链路接口。然后路由器有意将分组向该输出链路接口转发。

为了进一步深入理解查找操作，我们看一个特定的例子。假定所有的目的地址均是32比特（这恰好就是在IP数据报中的目的地址的长度）。转发表的蛮力实现将对每个可能的目的地址有一个表项。因为有超过40亿个可能的地址，这种选择完全是不可能的。

现在我们进一步假设路由器有4条链路，编号0～3，分组以如下方式转发到链路接口：

| 目的地址范围 | 链路接口 |
| :----: | :----: |
| `11001000 00010111 00010000 00000000`<br>到<br>`11001000 00010111 00010111 11111111` | 0 |
| `11001000 00010111 00011000 00000000`<br>到<br>`11001000 00010111 00011000 11111111` | 1 |
| `11001000 00010111 00011001 00000000`<br>到<br>`11001000 00010111 00011001 11111111` | 2 |
| 其他 | 3 |

显然，对于这个例子，在路由器的转发表中就没有必要有40亿表项。例如，我们能有仅包括4个表项的下列转发表：

| 前缀匹配 | 链路接口 |
| :----: | :----: |
| `11001000 00010111 00010` | 0 |
| `11001000 00010111 00011000` | 1 |
| `11001000 00010111 00011` | 2 |
| 其他 | 3 |

使用这种风格的转发表，路由器用分组的目的地址的**前缀（prefix）**与该表中的表项进行匹配。例如，假设分组的目的地址是`11001000 00010111 00010110 10100001`。因为该地址的21比特前缀匹配该表的第一项，所以路由器向链路接口0转发该分组。尽管听起来足够简单，但这里还是有重要的微妙之处。例如，地址`11001000 00010111 00010000 10101010`的前24比特与表中的第二项匹配，而该地址的前21比特与表中的第三项匹配。当有多个匹配时，该路由器使用**最长前缀匹配规则**。即在该表中寻找最长的匹配想，并向与最长前缀匹配相关联的链路接口转发分组。

虽然在数据报网络中的路由器不维持连接状态信息，但它们无论如何在其转发表中维持了转发状态信息。然而，转发状态信息表变化的时间尺度相对要慢。实际上，在数据报网络中的转发表是通过路由选择算法进行修改的，这通常每1～5分钟左右更新一次转发表。

{% note warning %}
**因为在数据报网络中的转发表能够在任何时刻修改，从一个端系统到另一个端系统发送一系列分组可能在通过网络时走不同的路径，并可能无序到达。**
{% endnote %}

# 网际协议：因特网中的转发和编址

因特网编址和转发是网纪协议（IP）的重要组件。目前有两个版本的IP在使用，我们首先研究广泛部署的IP协议版本4，这通常简称为IPv4，之后再介绍IP版本6，简称IPv6。

## 数据报格式

以前介绍过，网络层分组被称为**数据报**。我们以概述IPv4数据报的语法和语义开始对IP的学习。它的数据报格式如下所示：

![IPv4数据报格式](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E8%B7%AF-%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%96%B9%E6%B3%95/%E7%BD%91%E7%BB%9C%E5%B1%82/IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)

{% note info %}
- **版本号**：这4比特规定了数据报的IP协议版本。通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分。不同的IP版本使用不同的数据报哦格式。
- **首部长度**：因为一个IPv4数据报可包含一些可变数量的选项，故需要用这4比特来确定IP数据报中数据部分实际从哪里开始。
- **数据报长度**：IP数据报的总长度（首部加上数据），以字节计。因为该字段长为16比特，所以IP数据报的理论最大长度为65535字节。
- **标识**：每一个数据报从发送端被发出时，都会为其贴上标识号，这样在路由器中如果被分片的话，也可以根据标识号确认哪些片可以重新组成一个初始的数据报。
- **标志**：标志字段是3比特的。第一个比特保留。第二个比特（Don't Fragment, DF）为1代表未分片，为0代表分片。第三个比特（More Fragment, MF）为1代表后面还有片，为0代表是最后一个片。
- **片偏移**：假如片偏移字段值为n，则代表片中数据起始于原始数据的第8n个字节。
- **寿命**：寿命（Time-To-Live, TTL）字段用来确保数据报不会永远在网络中循环。每当数据报由一台路由器处理时，该字段的值减1。若TTL字段减为0，则该数据报必须丢弃。
- **上层协议**：该字段仅在一个IP数据报到达其最终目的地才会有用。该字段值指示了IP数据报的数据部分应交给哪个特定的运输层协议。例如，值为6表明数据报部分要交给TCP，而值为17表明数据要交给UDP。
- **首部检验和**：用于帮助路由器检测收到的IP数据报中的比特错误。路由器要对每个收到的IP数据报计算其首部检验和，如果数据报首部中携带的检验和与计算得到的检验和不一致，则检测出是个差错。路由器一般会丢弃检测出错误的数据报。注意到在每台路由器上必须重新计算检验和并再次存放到原处，因为TTL字段以及可能的选项字段会改变。
- **选项**：选项字段允许IP首部被扩展。
{% endnote %}

{% note warning %}
**为什么TCP/IP在运输层与网络层都执行差错检测？**
首先，IP层只对IP首部计算了检验和，而TCP/UDP检验和是对整个TCP/UDP报文段进行的。其次，TCP/UDP与IP不一定都必须属于同一个协议栈。原则上TCP能运行在一个不同的协议（如ATM）上，而IP能够携带不一定要传递给TCP/UDP的数据。
{% endnote %}

不同链路层协议能承载的网络层分组长度是不同的，我们称一个链路层帧能承载的最大数据量叫做**最大传送单元（Maximum Transmission Unit, MTU）**。因为每个IP数据报封装在链路层帧中从一台路由器传输到下一台路由器，故链路层协议的MTU严格地限制着IP数据报的长度。当路由器发现过大的IP分组时，它将IP数据报中的数据分片成两个或更多个较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后向输出链路上发送这些帧。每个这些较小的数据报都成为片。

片在其到达目的地运输层以前需要重新组装。实际上，TCP与UDP都希望从网络层收到完整的为分片的报文。IPv4的设计者感到在路由器中重新组装数据报会给协议带来相当大的复杂性并且影响路由器性能。为坚持网络内核保持简单的原则，IPv4的设计者决定将数据报的重新组装工作放到端系统中，而不是放到网络路由器中。

当一台目的主机从相同源收到一系列数据报时，它需要确定这些数据报中的某些是否是一些原来较大的数据报的片。如果某些数据报是片的话，则它必须进一步确定何时收到了最后一片，并且如何将这些接收到的片拼接到一起以形成初始的数据报。为了让目的主机窒息感这些重新组装任务，IPv4的设计者将**标识、标志和片偏移字段**放在IP数据报首部中。当生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时再贴上标识号。发送主机通常将它发送的每个数据报的标识号加1。当某路由器需要对一个数据报分片时，形成的每个数据报（即片）具有初始数据报的源地址、目的地址与标识号。当目的地从统一发送主机收到一系列数据报时，它能够检查数据报的标识号以确定那些数据报实际上是同一较大数据报的片。由于IP是一种不可靠的服务，一个或多个片可能永远到达不了目的地。所以为了让目的主机绝对地相信它已收到了初始数据报的最后一个片，最后一个片的标志字段被设为0，而所有其他片的标志字段被设为1。另外，为了让目的主机确定是否丢失了一个片（且能按正确的顺序重新组装片），使用偏移量字段制定该片应该放在初始IP数据报的哪个位置。

下图展示了一个例子。一个4000字节的数据报（20字节IP首部加上3980字节IP有效载荷）到达一台路由器，且必须被转发到一条MTU为1500字节的链路上。这就意味着初始数据报中3980字节数据必须被分配为3个独立的片。假定初始数据报上的标识号为777。

![IP分片与重新组装](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E8%B7%AF-%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%96%B9%E6%B3%95/%E7%BD%91%E7%BB%9C%E5%B1%82/IP%E5%88%86%E7%89%87%E4%B8%8E%E9%87%8D%E6%96%B0%E7%BB%84%E8%A3%85.png)

## IPv4编址

一台主机通常只有一条链路连接到网络，当主机中的IP想发送一个数据报时，他就在该链路上发送。主机与物理链路之间的边界叫做**接口**。因为路由器的任务是从链路上接收数据报并从某些其他链路转发出去，路由器必须拥有两条或更多条链路与它连接。路由器与它的任意一条链路之间的边界也叫做接口。一台路由器因此有多个接口，每个接口有其链路。因为每台主机与路由器都能发送和接收IP数据报，IP要求每台主机和路由器接口拥有自己的IP地址。因此，**一个IP地址技术上是与一个接口相关联的，而不是与包括该接口的主机或路由器相关联。**

每个IP地址长度为4个字节，这些地址一般按所谓的**点分十进制记法**书写，即地址中的每个字节用它的十进制形式书写，各字节间以`.`隔开。例如，IP地址`193.32.216.9`，193是该地址第一个字节的十进制等价数，32是该地址第二个字节的十进制等价数，依此类推。因此，它的二进制记法是`11000001 00100000 11011000 00001001`。

在全球因特网中的每台主机和路由器上的每个接口，必须有一个全球唯一的IP地址。然而，这些地址不能随意地自由选择。一个接口的IP地址的一部分需要由其连接的子网来决定。下面提供了一个IP编址与接口的例子。在该图中，一台路由器（具有3个接口）用于互联7台主机。左上侧部分的3台主机以及它们连接的路由器接口，都有一个形如`233.1.1.xx`的IP地址。这就是说，在它们的IP地址中，最左侧的24比特是相同的。

用IP的术语来说，互联这3个主机接口与1个路由器接口的网络形成一个**子网**。IP编址为这个子网分配一个地址：`233.1.1.0/24`，其中的`/24`指示了32比特中的最左侧24比特定义了子网地址。通过**子网掩码**可以将IP地址划分为两部分，对于`233.1.1.0/24`，它的子网掩码二进制形式为`11111111 11111111 11111111 00000000`，点分十进制记法为`255.255.255.0`。可以看出子网掩码中子网地址部分全部用1表示，而剩余部分则全为0。

{% note warning %}
**子网掩码为x的子网，最多可分配多少个可用的IP地址？**
最多可分配($2^{32-x}-2$)个IP地址。之所以减2，是因为需要预留两个用于网络地址和广播地址。
{% endnote %}

![接口地址与子网](https://blog-images-1258719270.cos.ap-shanghai.myqcloud.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E8%B7%AF-%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%96%B9%E6%B3%95/%E7%BD%91%E7%BB%9C%E5%B1%82/%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80%E4%B8%8E%E5%AD%90%E7%BD%91.png)

因特网的地址分配策略被称为**无类别域间路由选择（Classless Interdomain Routing, CIDR）**。CIDR将子网寻址的概念一般化了。因为对于子网寻址，32比特的IP地址被划分为两部分，并且也具有点分十进制数形式`a.b.c.d/x`，其中x指示了地址的第一部分中的比特数，x最高比特构成了IP地址的**网络部分**，并且经常被称为该地址的**前缀（或网络前缀）**。一个组织通常被分配一块连续的地址，即具有相同前缀的一段地址，在这种情况下，该组织内部的设备的IP地址将共享共同的前缀。这相当大地减少了在这些路由器中转发表的长度，因为形式为`a.b.c.d/x`单一表项足以将数据报转发到该组织内的任何目的地。一个地址的剩余32-x比特可认为是用于区分该组织内部设备的，其中的所有设备具有相同的网络前缀。

在CIDR被采用之前，IP地址的网络部分被限制为长度为8、16或24比特，这是一种称为**分类编制**的编址方案，这是因为具有8、16和24比特子网地址的子网分别被称为A、B和C类网络。这种方案是由缺陷的，不详细叙述了。

## IPv6

未完待续......

